{% extends 'web/app/app_base.html' %}
{% block app %}
<div class="app-card">
  <div class="flex">
    <div class="flex-1">
      <h1 class="pg-title">{{ experiment.name }}</h1>
    </div>
    <div class="justify-self-end">
      <div class="dropdown">
        <button class="btn btn-primary btn-circle">
          <i class="fa-solid fa-ellipsis"></i>
        </button>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
          <li>
            <form method="post" action="{% url 'experiments:start_session' team.slug experiment.id %}" class="inline">
              {% csrf_token %}
              <input type="submit" value="New Session"/>
            </form>
          </li>
          {% if experiment.is_active %}
            <li>
              <a href="{% url 'experiments:start_experiment' team.slug experiment.public_id %}">Public
                Experiment Link</a>
            </li>
          {% endif %}
          {% if request.user.is_superuser %}
            <li><a href="{% url 'experiments:experiment_invitations' team.slug experiment.id %}">Invitations</a></li>
          {% endif %}
          {% if request.user.is_superuser %}
            <li>
              <a href="{% url 'experiments:edit' team.slug experiment.id %}">Edit
                Experiment</a>
            </li>
            <li><a href="{% url 'experiments:delete' team.slug experiment.id %}">Delete
              Experiment</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
  <h2 class="flex-1 pg-subtitle my-2">{{ experiment.description }}</h2>
  <h3 class="inline mr-4">Channels:</h3>
  <i class="fa-regular fa-window-maximize"></i> Web
  <div class="dropdown">
    <button class="btn btn-ghost btn-sm">
      <i class="fa-regular fa-plus"></i>
    </button>
    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border">
      {% for platform in platforms %}
        <li><a onclick="{{ platform.value }}_modal.showModal()">{{ platform.label }}</a></li>
      {% endfor %}
    </ul>
  </div>
  {% for platform in platforms %}
    <dialog id="{{ platform.value }}_modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Link with {{ platform.label }}</h3>
        <form method="post">
          <p class="py-4">Press ESC key or click the button below to close</p>
          <div class="modal-action">
            <button class="btn btn-primary" type="submit">Create Link</button>
            <button class="btn" type="button" onclick="{{ platform.value }}_modal.close()">Close</button>
          </div>
        </form>
      </div>
    </dialog>
  {% endfor %}
  <hr class="m-2">

  <h2 class="pg-subtitle">Previous Chat Sessions</h2>
  <div class="overflow-x-auto">
    <table class="pg-table">
    <thead>
    <tr>
      <th>Started</th>
      <th>Last Message</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for session in sessions %}
      <tr>
        <td>{{ session.created_at }}</td>
        <td>{{ session.updated_at }}</td>
        <td>
          <a class="btn btn-sm btn-outline btn-primary" href="{% url 'experiments:experiment_chat_session' team.slug experiment.id session.id %}" class="link">Continue Chat</a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
    </table>
  </div>
</div>
{% if request.user.is_superuser %}
<div class="app-card">
  <h2 class="pg-subtitle">All Chat Sessions</h2>
  <form method="post" action="{% url 'experiments:download_experiment_chats' team.slug experiment.id %}" class="my-2">
    {% csrf_token %}
    <input class="btn btn-sm btn-outline btn-primary" type="submit" value="Download All" />
  </form>
  <div class="overflow-x-auto">
    <table class="pg-table">
    <thead>
    <tr>
      <th>User</th>
      <th>Started</th>
      <th>Last Message</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for session in experiment.sessions.all %}
      <tr>
        <td>{{ session.user|default:"-" }}</td>
        <td>{{ session.created_at }}</td>
        <td>{{ session.updated_at }}</td>
        <td>
          <a class="btn btn-sm btn-outline btn-primary" href="{% url 'experiments:experiment_session_view' team.slug experiment.public_id session.public_id %}" class="link">
            Session Details
          </a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
