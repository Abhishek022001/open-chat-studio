{% extends "generic/object_form.html" %}
{% load form_tags %}
{% block form %}
  {% render_form_fields form "name" "description" "llm_provider" "llm" %}
  <div x-show="llmProvider !== null && llmProvider.supports_assistants">
  {% render_form_fields form "assistant" %}
  </div>
  {% render_form_fields form "max_token_limit" "temperature" "prompt_text" "input_formatter" "safety_layers" "tools_enabled" %}
  {% render_form_fields form "conversational_consent_enabled" "source_material" "seed_message" "pre_survey" %}
  {% render_form_fields form "post_survey" "consent_form" "voice_provider" "synthetic_voice" "no_activity_config" "safety_violation_notification_emails" %} %}
{% endblock form %}
{% block page_js %}
  {{ voice_providers_types|json_script:"voiceProviderTypes" }}
  {{ synthetic_voice_options|json_script:"voiceOptions" }}
  {{ llm_options|json_script:"llmModelOptions" }}
  <script>
      const voiceProviderTypes = JSON.parse(document.getElementById("voiceProviderTypes").textContent);
      const voiceOptions = JSON.parse(document.getElementById("voiceOptions").textContent);
      const llmModelOptions = JSON.parse(document.getElementById("llmModelOptions").textContent);
      document.addEventListener('alpine:init', () => {
          Alpine.data('experiment', () => ({

              voiceProvider: null,
              synthetic_voice: {{experiment.synthetic_voice_id|default:'null'}},
              synthetic_voice_options: [],

              llmProviderId: null,
              llmProvider: null,
              llm: '{{experiment.llm|default:'null'}}',
              llm_options: [],

              init() {

                  this.$watch('voiceProvider', () => {
                      const providerType = voiceProviderTypes[this.voiceProvider];
                      this.synthetic_voice_options = voiceOptions.filter(option => {
                        return option.type === providerType;
                      });
                  });

                  this.$watch('llmProviderId', () => {
                      this.llmProvider = llmModelOptions[this.llmProviderId];
                      this.llm_options = llmModelOptions[this.llmProviderId].models;
                  })
              }
          }));
      });
  </script>
{% endblock page_js %}
