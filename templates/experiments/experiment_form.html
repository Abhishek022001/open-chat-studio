{% extends "generic/object_form.html" %}
{% load i18n %}
{% load waffle_tags %}
{% load static %}
{% load form_tags %}
{% block breadcrumbs %}
  <div class="text-sm breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li><a href="{% url 'experiments:experiments_home' request.team.slug %}">Experiments</a></li>
      {% if experiment.id %}
        <li><a
          href="{% url 'experiments:single_experiment_home' request.team.slug experiment.id %}">{{ experiment.name }}</a>
        </li>
        <li class="pg-breadcrumb-active" aria-current="page">Edit</li>
      {% else %}
        <li class="pg-breadcrumb-active" aria-current="page">Create</li>
      {% endif %}
    </ul>
  </div>
{% endblock %}
{% block form %}
  <div>
    {% render_form_fields form "name" "description" "consent_form" %}
    <div class="divider"></div>
    {% render_form_fields form "type" %}
    {% if form.fields.assistant.choices|length <= 1 %}
      {# choices has an option for none so it is never empty #}
      <div x-show="type === 'assistant'" x-cloak>
        {% url "assistants:home" request.team.slug as new_assistant_url %}
        <p class="text-error">{% blocktranslate %}
          No assistants have been created. <a class="link" href="{{ new_assistant_url  }}">Create one now</a>.
        {% endblocktranslate %}</p>
      </div>
    {% endif %}

    <div role="tablist" class="tabs tabs-bordered grid-flow-col auto-cols-max mt-4">
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Language Model" x-bind:checked="type === 'llm'" x-show="type === 'llm'" {% if experiment_type != "llm" %}x-cloak{% endif %}>
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "llm_provider" "llm" "temperature" "prompt_text" %}
      </div>
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="OpenAI Assistant" x-bind:checked="type === 'assistant'" x-show="type === 'assistant'" {% if experiment_type != "assistant" %}x-cloak{% endif %}>
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "assistant" %}
      </div>
      {% flag "pipelines-v2" %}
        <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Pipeline" x-bind:checked="type === 'pipeline'" x-show="type === 'pipeline'" {% if experiment_type != "pipeline" %}x-cloak{% endif %}>
        <div role="tabpanel" class="tab-content">
          {% render_form_fields form "pipeline" %}
        </div>
      {% endflag %}
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Safety" x-show="type !== 'pipeline'">
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "safety_layers" "safety_violation_notification_emails" "input_formatter" "max_token_limit" %}
      </div>
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Consent" x-show="type !== 'pipeline'">
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "conversational_consent_enabled" %}
      </div>
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Surveys" x-show="type !== 'pipeline'">
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "pre_survey" "post_survey" %}
      </div>
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Voice" x-show="type !== 'pipeline'">
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "voice_provider" "synthetic_voice" "voice_response_behaviour" "echo_transcript" "use_processor_bot_voice" %}
      </div>
      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Source Material" x-show="type === 'llm'" {% if experiment_type != "llm" %}x-cloak{% endif %}>
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "source_material" %}
        {% flag "experiment_rag" %}
          {% if not object.id %}
            {% include "files/partials/file_formset.html" %}
          {% else %}
            <hr class="my-4">
            {% url "experiments:add_file" request.team.slug object.id as upload_url %}
            {% url "experiments:remove_file" request.team.slug object.id '000' as delete_url %}
            {% include "files/partials/file_list.html" with files=object.files.all nested=True %}
          {% endif %}
        {% endflag %}
      </div>

      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Tools" x-show="type === 'llm'">
      <div role="tabpanel" class="tab-content">
        <div class="py-4 form-text">
          <h3 class="text-md font-bold">{% translate "Please note" %} <i class="fas fa-exclamation-triangle"></i></h3>
          <p class="text-sm">{% translate "Make sure that your selected model supports tool usage" %}</p>
        </div>
        {% render_form_fields form "tools" %}
      </div>

      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Allowlist">
      <div role="tabpanel" class="tab-content">
        <h3 class="text-md font-bold">{% translate "Please note" %}</h3>
        <p class="py-4 text-sm">
          {% blocktranslate %}
            To limit the set of particiapants that can chat with this bot, simply add their identifiers in this list.
            When the list is empty, the bot will accessible via its public link.
          {% endblocktranslate %}
          <div class="w-96 my-2" x-data="{allowlist: {{ form.initial.participant_allowlist|default:'[]' }}}">
            <input type="hidden" name="participant_allowlist" id="id_participant_allowlist" :value="allowlist"></input>
            <select x-model="allowlist" id="allowlist-multiselect" name="state[]" multiple placeholder="Add participant identifier..." autocomplete="off">
              {% for identifier in team_participant_identifiers %}
                <option value="{{ identifier }}" {% if identifier in form.initial.participant_allowlist %}selected{% endif %}>{{ identifier }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn btn-ghost btn-sm no-animation !normal-case" onclick="SiteJS.app.copyToClipboard(this, 'id_participant_allowlist')" title="Copy to clipboard">
              <i class="fa-solid fa-copy"></i> <span>Copy participant list</span>
            </button>
          </div>
        </p>
      </div>

      <input type="radio" name="main_tabs" role="tab" class="tab" aria-label="Advanced" x-show="type !== 'pipeline'">
      <div role="tabpanel" class="tab-content">
        {% render_form_fields form "seed_message" "trace_provider" "debug_mode_enabled" %}
        <span x-show="type == 'assistant'">
          {% render_form_fields form "citations_enabled" %}
        </span>
      </div>
    </div>
{% endblock form %}
{% block page_js %}
  {{ voice_providers_types|json_script:"voiceProviderTypes" }}
  {{ synthetic_voice_options|json_script:"voiceOptions" }}
  {{ llm_options|json_script:"llmModelOptions" }}
  <script src="{% static 'js/app-bundle.js' %}"></script>
  <script>

    let element = document.getElementById('allowlist-multiselect');
    new TomSelect(element, {
      maxItems: null,
      create: true,
      plugins: {
        'checkbox_options': {
          'checkedClassNames':   ['ts-checked'],
          'uncheckedClassNames': ['ts-unchecked'],
        }
      },
    });


    const voiceProviderTypes = JSON.parse(document.getElementById("voiceProviderTypes").textContent);
    const voiceOptions = JSON.parse(document.getElementById("voiceOptions").textContent);
    const llmModelOptions = JSON.parse(document.getElementById("llmModelOptions").textContent);
    document.addEventListener('alpine:init', () => {
      Alpine.data('experiment', () => ({
        type: '{{ experiment_type }}',

        voiceProvider: null,
        synthetic_voice: {{experiment.synthetic_voice_id|default:'null'}},
        synthetic_voice_options: [],

        llmProviderId: null,
        llmProvider: null,
        llm: '{{experiment.llm|default:form.llm.value|default:'null'}}',
        llm_options: [],

        init() {

          this.$watch('voiceProvider', () => {
            const providerType = voiceProviderTypes[this.voiceProvider];
            this.synthetic_voice_options = voiceOptions.filter(option => {
              return option.type === providerType && (!option.provider_id || option.provider_id == this.voiceProvider);
            });
          });

          this.$watch('llmProviderId', () => {
            this.llmProvider = llmModelOptions[this.llmProviderId];
            this.llm_options = llmModelOptions[this.llmProviderId].models;
          })
        }
      }));
    });
  </script>
{% endblock page_js %}
