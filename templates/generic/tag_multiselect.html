{% load static %}

<div id="linkTagDiv" data-url="{% url 'annotations:link_tag' %}"></div>
<div id="unlinkTagDiv" data-url="{% url 'annotations:unlink_tag' %}"></div>

<!-- TODO: Load this from static files -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<div>
  <select id="tag-select" name="state[]" multiple placeholder="Select a tag..." autocomplete="off">
    <option value="">Select a tag...</option>
    {% for tag in available_tags %}
      <option value="{{ tag }}" {% if tag in object_tags %}selected{% endif %}>{{ tag }}</option>
    {% endfor %}
  </select>
</div>

{{ object_info|json_script:"objectInfo" }}
<script>
  let objectInfo = JSON.parse(document.getElementById("objectInfo").textContent);

  let linkUrl = document.getElementById("linkTagDiv").getAttribute("data-url");
  let unlinkUrl = document.getElementById("unlinkTagDiv").getAttribute("data-url");

  var addTag = function(name) {
    return function() {
      console.log("Adding ", arguments[0]);
      let postData = {swap: 'none', values: {"tag_name": arguments[0], "object_info": objectInfo}};
      htmx.ajax('POST', linkUrl, postData);
    };
  };

  var removeTag = function(name) {
    return function() {
      console.log("Removing ", arguments[0]);
      let postData = {swap: 'none', values: {"tag_name": arguments[0], "object_info": objectInfo}};
      htmx.ajax('POST', unlinkUrl, postData);
    };
  };
  var settings = {};
  new TomSelect("#tag-select", {
    maxItems: 10,
    onItemAdd: addTag('onItemAdd'),
    onItemRemove: removeTag('onItemRemove')
  });

</script>
